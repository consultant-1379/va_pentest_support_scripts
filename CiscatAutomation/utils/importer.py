import csv
import os
import re
from io import StringIO
import pandas as pd
import xlsxwriter
from openpyxl import Workbook
def csv_to_excel(directory_path):
    workbook = Workbook()
    with pd.ExcelWriter('C:\\Users\\EENRMUS\\scriptCiscat\\reports\\pENM\\429\\excel_output.xlsx', engine='xlsxwriter') as writer:
        workbook = writer.book
        format = workbook.add_format()
        format.set_align('left')
        flist = os.listdir(directory_path)
        newlist = []
        cc=0
        for filename in flist:
            if filename.endswith('.csv'):
                title = re.sub(r'\-[\dZT]+', '', filename.replace('.csv', ''))
                title = re.sub(r'Ericsson_Red_Hat_Enterprise_Linux_(\d+)_Benchmark', r'ERH\1', title)
                title = re.sub(r'CIS_Red_Hat_Enterprise_Linux_(\d+)_Benchmark', r'RH\1', title)
                title = re.sub(r'CIS_SUSE_Linux_Enterprise_(\d+)_Benchmark', r'Suse\1', title)
                title = re.sub(r'-xccdf.xml_', '', title)
                title = re.sub(r'_-_Server', '', title)
                title = re.sub(r'Level_', 'L', title)
                title = re.sub(r'_v\d(\.\d+)*', '', title)
                title = re.sub(r'^[^\-]+\-', '', title)
                #newlist.append(f'{title}|{filename}')
                newlist.append(f'sheet_{str(cc)}|{filename}')
                cc +=1
        newlist.sort()
        for fln in newlist:
            title = fln.split('|')[0]
            filename = fln.split('|')[1]
            print(title)
            fixedlines = fixComma(os.path.join(directory_path, filename))
            string = '\n'.join(fixedlines)
            csvStringIO = StringIO(string)
            df = pd.read_csv(csvStringIO, usecols=range(15))
            df.to_excel(writer, sheet_name=title, index=False)
            sheet = writer.sheets[title]
            (max_row, max_col) = df.shape
            column_settings = [{'header': column} for column in df.columns.to_list()]
            sheet.add_table(0, 0, max_row, max_col - 1, {'columns': column_settings, 'style': 'Table Style Medium 11'})
            sheet.set_column(0, max_col - 1, 20, format)
def fixComma(file):
    with open(file) as f:
        lines = f.read().splitlines()
        commas = [len(re.findall(',', l)) for l in lines]
        m = max(commas)
        new = []
        for l in lines:
            new.append(l + ','*(m-len(re.findall(',', l))))
        return new


csv_to_excel('C:\\Users\\EENRMUS\\scriptCiscat\\reports\\pENM\\429')